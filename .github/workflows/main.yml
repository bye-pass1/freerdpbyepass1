name: Windows-RDP-Forever

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Setup User
        run: |
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
          
      - name: Download Bore
        run: |
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip

      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      - name: Clean GitHub Workspace
        run: |
          Write-Host "Dang xoa sach du lieu source code GitHub..."
          Remove-Item "D:\a" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Da xoa xong!"

      # --- SỬA ĐỔI QUAN TRỌNG TẠI ĐÂY ---
      - name: Start Tunnel Loop
        run: |
          Write-Host "Bat dau tao Tunnel..."
          # Vòng lặp vô hạn: Nếu bore bị tắt, nó sẽ tự bật lại sau 1 giây
          # Điều này ngăn không cho Workflow kết thúc sớm
          while ($true) {
            try {
              .\bore\bore.exe local 3389 --to bore.pub
            } catch {
              Write-Host "Bore gap loi, dang thu lai..."
            }
            Write-Host "Bore da ngat ket noi. Tu dong ket noi lai sau 1 giay..."
            Start-Sleep -Seconds 1
          }
