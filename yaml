name: Windows-RDP-Cloudflare

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      # 1. Cấu hình User và Mật khẩu cho RDP
      - name: Setup User
        run: |
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
          
      # 2. Tải Cloudflare Tunnel (Thay thế Ngrok)
      - name: Download Cloudflared
        run: |
          Invoke-WebRequest -Uri https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

      # 3. Kích hoạt Remote Desktop trên Windows Runner
      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      # 4. Tạo đường hầm (Tunnel) và giữ kết nối
      - name: Start Tunnel
        run: |
          Write-Host "Dang khoi tao Tunnel... Hay kiem tra log de lay dia chi ket noi."
          .\cloudflared.exe tunnel --url tcp://localhost:3389
